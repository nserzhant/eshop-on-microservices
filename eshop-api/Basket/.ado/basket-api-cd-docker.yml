# BASKET API RELEASE PIPELINE (Docker Image Deployment)

resources:
  repositories:
  - repository: self
    trigger: none
  pipelines:
  - pipeline: basket-api-ci-docker
    source: basket-api-ci-docker

variables:
- group: microservices-variable-group

- name: azureserviceconnection
  value: 'azure-docker-spn'
- name: suffix
  value: ${{ split(variables['System.TeamProjectId'], '-')[0]}} # Random string based on project Id
- name: webappname
  value: 'basket-api-web-app-$(suffix)'
- name: repositoryName
  value: 'eshop.basket.api'
- name: dockerregistryurl
  value: 'https://index.docker.io/v1/'
- name: userName
  value: '$(docker-registry-username)' # From variable group
- name: dockerRegistryPassword
  value: '$(docker-registry-read-token)' # From variable group
    
pool:
  vmImage: windows-latest

steps:
- checkout: none

- task: AzureWebAppContainer@1
  displayName: Deploy Web App
  inputs:
    azureSubscription: '$(azureserviceconnection)'
    appName: '$(webappname)'
    containers: '$(userName)/$(repositoryName):$(resources.pipeline.basket-api-ci-docker.runID)'
    appSettings: |
      -DOCKER_REGISTRY_SERVER_USERNAME "$(userName)" 
      -DOCKER_REGISTRY_SERVER_URL "$(dockerregistryurl)" 
      -DOCKER_REGISTRY_SERVER_PASSWORD "$(dockerRegistryPassword)"

- powershell: Invoke-WebRequest -UseBasicParsing https://$(webappname).azurewebsites.net/hc -TimeoutSec 300
  displayName: Check Web App