# PAYMENT PROCESSOR BUILD PIPELINE

resources:
  repositories:
  - repository: self
    trigger: none

variables:
- group: microservices-variable-group

- name: buildConfiguration
  value: 'Release'
- name: workingDirectory
  value: '$(System.DefaultWorkingDirectory)/eshop-api/Payment'
- name: sqlPassword
  value: 'sqlP@ssw0rd'
- name: userName
  value: '$(docker-registry-username)' # From variable group
- name: imageName
  value: '$(username)/eshop.payment.processor'
- name: dockerRegistryConnection
  value: 'docker-connection'

pool:
  vmImage: ubuntu-latest

steps:
- task: Docker@2
  displayName: 'Build The Docker Image'
  inputs:
    containerRegistry: '$(dockerRegistryConnection)'
    repository: '$(imageName)'
    command: 'build'
    Dockerfile: '$(workingDirectory)/src/EShop.Payment.Processor/Dockerfile'
    buildContext: '$(workingDirectory)'
    tags: |
      $(Build.BuildId)
      latest

- task: Docker@2
  displayName: 'Push The Docker Image'
  inputs:
    containerRegistry: '$(dockerRegistryConnection)'
    repository: '$(imageName)'
    command: 'push'
    tags: |
      $(Build.BuildId)
      latest
        
- task: PublishPipelineArtifact@1
  displayName: Publish Pipepile Artifact - Bicep
  inputs:
    targetPath: '$(workingDirectory)/.azure/'
    artifact: 'Bicep'
    publishLocation: 'pipeline'