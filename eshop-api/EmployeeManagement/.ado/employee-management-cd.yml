#EMPLOYEE MANAGEMENT SERVICES RELEASE PIPELINE

resources:
 repositories:
   - repository: self
     trigger: none
 pipelines:
   - pipeline: employee-management-ci
     source: employee-management-ci
     trigger: none

variables:
  suffix: ${{ split(variables['System.TeamProjectId'], '-')[0]}} # Pseudo - random string based on project Id
  azureserviceconnection: 'azure-spn'
  apiWebAppName: employee-api-web-app-$(suffix)
  authServerWebAppName: employee-authserver-web-app-$(suffix)
  administratorLoginPassword: $(sqlPasswordSecret) #create secret using variables section
  templateFileName: 'webapps-with-sql.bicep'
  subscriptionid: $(subscription-id) # Create the "subscription-id" pipeline variable in Variables section or replace the expression by the value
  resourceGroupName: 'eshop-on-microservices-rg'
  location: 'westeurope'
  
pool:
  vmImage: windows-latest

steps:
- checkout: none
- download: employee-management-ci

 # Deploy Web App Infrastructure Using Bicep
- task: AzureResourceManagerTemplateDeployment@3
  displayName: Deploy Web Apps Bicep
  inputs:
    deploymentScope: 'Resource Group'
    azureResourceManagerConnection: '$(azureserviceconnection)'
    subscriptionId: '$(subscriptionid)'
    action: 'Create Or Update Resource Group'
    resourceGroupName: '$(resourceGroupName)'
    location: '$(location)'
    templateLocation: 'Linked artifact'
    csmFile: '$(Pipeline.Workspace)/employee-management-ci/Bicep/$(templateFileName)'
    overrideParameters: '-apiWebAppName $(apiWebAppName) -authServerWebAppName $(authServerWebAppName) -administratorLoginPassword $(administratorLoginPassword)'
    deploymentMode: 'Incremental'

- powershell: az cache purge
  displayName: Clear Azure Cache

- task: AzureRmWebAppDeployment@4
  displayName: Deploy Api
  inputs:
    ConnectionType: 'AzureRM'
    azureSubscription: '$(azureserviceconnection)'
    appType: 'webApp'
    WebAppName:  '$(apiWebAppName)' 
    packageForLinux: '$(Pipeline.Workspace)/employee-management-ci/EmployeeManagement Api/*.zip'

- task: AzureRmWebAppDeployment@4
  displayName: Deploy Authorization Server
  inputs:
    ConnectionType: 'AzureRM'
    azureSubscription: '$(azureserviceconnection)'
    appType: 'webApp'
    WebAppName:  '$(authServerWebAppName)' 
    packageForLinux: '$(Pipeline.Workspace)/employee-management-ci/Authorization Server/*.zip'

- powershell: Invoke-WebRequest -UseBasicParsing https://$(apiWebAppName).azurewebsites.net/swagger/index.html -TimeoutSec 300
  displayName: Init And Check Api Web App

- powershell: Invoke-WebRequest -UseBasicParsing https://$(authServerWebAppName).azurewebsites.net/ -TimeoutSec 300
  displayName: Init And Check Authorization Server Web App