resources:
 repositories:
   - repository: self
     trigger: none
 pipelines:
  - pipeline: eshop-on-microservices-ci
    source: eshop-on-microservices-ci

variables:
  suffix: ${{ split(variables['System.TeamProjectId'], '-')[0]}} # Pseudo - random string based on project Id
  
  azureserviceconnection: 'azure-spn'
  subscriptionid: $(subscription-id) # Create the "subscription-id" pipeline variable in Variables section or replace the expression by the value
  storageAccountName: 'storageacc$(suffix)'
  clientGatewayConfigContainerName: 'clientgateway'
  employeeGatewayConfigContainerName: 'employeegateway'
  clientProxyConfigurationFile: 'nginx-proxy/nginx-client-azure.conf'
  employeeProxyConfigurationFile: 'nginx-proxy/nginx-employee-azure.conf'
  resourceGroupName: 'eshop-on-microservices-rg'

  clientGatewayAppName: 'client-portal-gateway-$(suffix)'
  employeeGatewayAppName: 'employee-portal-gateway-$(suffix)'
  clientPortalStaticAppName: 'client-portal-$(suffix)'
  employeePortalStaticAppName: 'employee-portal-$(suffix)'
  catalogApiWebAppName: 'catalog-api-web-app-$(suffix)'
  clientAuthServerWebAppName: 'client-auth-web-app-$(suffix)'
  employeeApiWebAppName: 'employee-api-web-app-$(suffix)'
  employeeAuthServerWebAppName: 'employee-authserver-web-app-$(suffix)'

  location: 'westeurope'
  
pool:
  vmImage: ubuntu-latest

steps:
- download: eshop-on-microservices-ci

- task: AzureResourceManagerTemplateDeployment@3
  displayName: Deploy Bicep
  inputs:
    deploymentScope: 'Resource Group'
    azureResourceManagerConnection: '$(azureserviceconnection)'
    subscriptionId: '$(subscriptionid)'
    action: 'Create Or Update Resource Group'
    resourceGroupName: '$(resourceGroupName)'
    location: '$(location)'
    templateLocation: 'Linked artifact'
    csmFile: '$(System.DefaultWorkingDirectory)/.azure/main.bicep'
    overrideParameters: '-employeeGatewayAppName $(employeeGatewayAppName) -clientGatewayAppName $(clientGatewayAppName) -catalogApiWebAppName $(catalogApiWebAppName) -clientAuthServerWebAppName $(clientAuthServerWebAppName) -employeeApiWebAppName $(employeeApiWebAppName) -employeeAuthServerWebAppName $(employeeAuthServerWebAppName) -clientPortalStaticAppName $(clientPortalStaticAppName) -employeePortalStaticAppName $(employeePortalStaticAppName) -storageAccountName $(storageAccountName)'
    deploymentMode: 'Incremental'
    deploymentOutputs: 'deploymentOutputs'

- powershell: |
    $var=ConvertFrom-Json '$(deploymentOutputs)'
    $clientPortalDNSValue=$var.staticAppDNSNames.value.clientPortal
    $employeePortalDNSValue=$var.staticAppDNSNames.value.employeePortal
    Write-Host "##vso[task.setvariable variable=clientAppDomainName;]$clientPortalDNSValue"
    Write-Host "##vso[task.setvariable variable=employeeAppDomainName;]$employeePortalDNSValue"
  displayName: Get Static Apps Domain Names

- powershell: (Get-Content '$(clientProxyConfigurationFile)' -Encoding utf8) `
      -replace '__clientAppDomainName__', '$(clientAppDomainName)' `
      -replace '__catalogApiWebAppName__', '$(catalogApiWebAppName)' `
      -replace '__clientAuthServerWebAppName__', '$(clientAuthServerWebAppName)' `
    | Set-Content '$(clientProxyConfigurationFile)'
  displayName: Replace Client Gateway Tokens
  
- script: cat '$(clientProxyConfigurationFile)'
  displayName: Client Gateway Config Display

- powershell: (Get-Content '$(employeeProxyConfigurationFile)' -Encoding utf8) `
      -replace '__employeeAppDomainName__', '$(employeeAppDomainName)' `
      -replace '__catalogApiWebAppName__', '$(catalogApiWebAppName)' `
      -replace '__employeeApiWebAppName__', '$(employeeApiWebAppName)' `
      -replace '__employeeAuthServerWebAppName__', '$(employeeAuthServerWebAppName)' `
    | Set-Content '$(employeeProxyConfigurationFile)'
  displayName: Replace Employee Gateway Tokens

- script: cat '$(employeeProxyConfigurationFile)'
  displayName: Employee Gateway Config Display

- task: AzureCLI@2
  displayName: Get Storage Account Key
  inputs:
    azureSubscription: '$(azureserviceconnection)'
    scriptType: 'bash'
    scriptLocation: 'inlineScript'
    inlineScript: |
     ACCOUNT_KEY=$(az storage account keys list --account-name $(storageAccountName) --query '[0].value')
     echo "##vso[task.setvariable variable=storageAccountKey;issecret=true]$ACCOUNT_KEY"

- task: AzureCLI@2
  displayName: Upload Client Portal Gateway Configuration To Storage Account
  inputs:
    azureSubscription: '$(azureserviceconnection)'
    scriptType: 'bash'
    scriptLocation: 'inlineScript'
    inlineScript: az storage blob upload --account-name $(storageAccountName) --account-key $(storageAccountKey) --container-name $(clientGatewayConfigContainerName) --name nginx.conf --file '$(clientProxyConfigurationFile)' --overwrite

- task: AzureCLI@2
  displayName: Upload Employee Portal Gateway Configuration To Storage Account
  inputs:
    azureSubscription: '$(azureserviceconnection)'
    scriptType: 'bash'
    scriptLocation: 'inlineScript'
    inlineScript: az storage blob upload --account-name $(storageAccountName) --account-key $(storageAccountKey) --container-name $(employeeGatewayConfigContainerName) --name nginx.conf --file '$(employeeProxyConfigurationFile)' --overwrite

- task: AzureRmWebAppDeployment@4
  displayName: Deploy Catalog Api
  inputs:
    ConnectionType: 'AzureRM'
    azureSubscription: '$(azureserviceconnection)'
    appType: 'webApp'
    WebAppName: '$(catalogApiWebAppName)'
    deployToSlotOrASE: false
    ResourceGroupName: '$(resourceGroupName)'
    packageForLinux: '$(Pipeline.Workspace)/eshop-on-microservices-ci/Catalog Api/*.zip'

- task: AzureRmWebAppDeployment@4
  displayName: Deploy EmployeeManagement Api
  inputs:
    ConnectionType: 'AzureRM'
    azureSubscription: '$(azureserviceconnection)'
    appType: 'webApp'
    WebAppName:  '$(employeeApiWebAppName)'
    deployToSlotOrASE: false
    ResourceGroupName: '$(resourceGroupName)' 
    packageForLinux: '$(Pipeline.Workspace)/eshop-on-microservices-ci/EmployeeManagement Api/*.zip'
    
- task: AzureRmWebAppDeployment@4
  displayName: Deploy Employee Authorization Server
  inputs:
    ConnectionType: 'AzureRM'
    azureSubscription: '$(azureserviceconnection)'
    appType: 'webApp'
    WebAppName:  '$(employeeAuthServerWebAppName)' 
    deployToSlotOrASE: false
    ResourceGroupName: '$(resourceGroupName)'
    packageForLinux: '$(Pipeline.Workspace)/eshop-on-microservices-ci/Employee Authorization Server/*.zip'
    
- task: AzureRmWebAppDeployment@4
  displayName: Deploy Client Authorization Server
  inputs:
    ConnectionType: 'AzureRM'
    azureSubscription: '$(azureserviceconnection)'
    appType: 'webApp'
    WebAppName:  '$(clientAuthServerWebAppName)' 
    deployToSlotOrASE: false
    ResourceGroupName: '$(resourceGroupName)'
    packageForLinux: '$(Pipeline.Workspace)/eshop-on-microservices-ci/Client Authorization Server/*.zip'

- task: AzureCLI@2
  displayName: Get Client Portal Deployment Key
  inputs:
    azureSubscription: '$(azureserviceconnection)'
    scriptType: 'bash'
    scriptLocation: 'inlineScript'
    inlineScript: |
      APIKEY=$(az staticwebapp secrets list --n $(clientPortalStaticAppName)  --resource-group $(resourceGroupName) --subscription $(subscriptionid) | jq -r '.properties.apiKey')
      echo "##vso[task.setvariable variable=clientPortalDeploymentToken;issecret=true]$APIKEY"

- task: AzureStaticWebApp@0
  displayName: Deploy Client Portal Static Web App
  inputs:
    workingDirectory: '$(Pipeline.Workspace)/eshop-on-microservices-ci'
    app_location: 'ClientPortal'
    azure_static_web_apps_api_token:  $(clientPortalDeploymentToken)

- task: AzureCLI@2
  displayName: Get Employee Portal Deployment Key
  inputs:
    azureSubscription: '$(azureserviceconnection)'
    scriptType: 'bash'
    scriptLocation: 'inlineScript'
    inlineScript: |
      APIKEY=$(az staticwebapp secrets list --n $(employeePortalStaticAppName)  --resource-group $(resourceGroupName) --subscription $(subscriptionid) | jq -r '.properties.apiKey')
      echo "##vso[task.setvariable variable=employeePortalDeploymentToken;issecret=true]$APIKEY"

- task: AzureStaticWebApp@0
  displayName: Deploy Employee Portal Static Web App
  inputs:
    workingDirectory: '$(Pipeline.Workspace)/eshop-on-microservices-ci'
    app_location: 'EmployeePortal'
    azure_static_web_apps_api_token:  $(employeePortalDeploymentToken)

- task: AzureAppServiceManage@0
  displayName: Restrart Employee Gateway
  inputs:
    azureSubscription: '$(azureserviceconnection)'
    Action: 'Restart Azure App Service'
    WebAppName: '$(employeeGatewayAppName)'

- task: AzureAppServiceManage@0
  displayName: Restrart Client Gateway
  inputs:
    azureSubscription: '$(azureserviceconnection)'
    Action: 'Restart Azure App Service'
    WebAppName: '$(clientGatewayAppName)'

- powershell: Invoke-WebRequest -UseBasicParsing https://$(employeeGatewayAppName).azurewebsites.net -TimeoutSec 300
  displayName: Init And Check Employee Gateway App

- powershell: Invoke-WebRequest -UseBasicParsing https://$(clientGatewayAppName).azurewebsites.net -TimeoutSec 300
  displayName: Init And Check Client Gateway App

- powershell: Invoke-WebRequest -UseBasicParsing https://$(catalogApiWebAppName).azurewebsites.net/swagger/index.html -TimeoutSec 300
  displayName: Init And Check Catalog Api

- powershell: Invoke-WebRequest -UseBasicParsing https://$(clientAuthServerWebAppName).azurewebsites.net -TimeoutSec 300
  displayName: Init And Check Client Auth Server

- powershell: Invoke-WebRequest -UseBasicParsing https://$(employeeApiWebAppName).azurewebsites.net/swagger/index.html -TimeoutSec 300
  displayName: Init And Check Employee Api

- powershell: Invoke-WebRequest -UseBasicParsing https://$(employeeAuthServerWebAppName).azurewebsites.net -TimeoutSec 300
  displayName: Init And Check Employee Auth Server