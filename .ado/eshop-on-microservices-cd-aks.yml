resources:
 repositories:
   - repository: self
     trigger: none
 pipelines:
  - pipeline: eshop-on-microservices-ci-aks
    source: eshop-on-microservices-ci-aks

variables:
  azureserviceconnection: 'azure-spn'
  suffix:  ${{ split(variables['System.TeamProjectId'], '-')[0]}} # Pseudo - random string based on project Id
  resourceGroupName: 'eshop-aks'
  clusterName: 'aks-eshop-$(suffix)'
  acrConnection: 'acr-docker-connection'
  acrName: $(acr-name)
  workingDirectory:  $(System.DefaultWorkingDirectory)/.helm/eshop
  aksNamespace: 'eshop'
  dnsLabel: 'eshop-client-portal-$(suffix)'
  akvName: 'akv-eshop-$(suffix)'
  catalogApiSqlServerName: 'catalog-sqlserver-$(suffix)'
  employeeManagementSqlServerName: 'employee-sqlserver-$(suffix)'
  clientAuthserverSqlServerName: 'client-sqlserver-$(suffix)'
  catalogApiUMIName: 'catalog-api-identity'
  employeeManagementUMIName: 'employee-management-identity'
  clientAuthServerUMIName: 'client-authserver-identity'  
  employeeExternalOAuthIssuer: '' # When Empty Default Identity Server Will Be Used
  employeeExternalOAuthMetadataEndpoint: ''
  employeeExternalOAuthAudience: ''
pool:
  vmImage: windows-latest
steps:

- checkout: none
- download: eshop-on-microservices-ci-aks

- task: AzureCLI@2
  displayName: Get The Tenant Id (save result to tenantId variable)
  inputs:
    azureSubscription: '$(azureserviceconnection)'
    scriptType: 'bash'
    scriptLocation: 'inlineScript'
    inlineScript: |
     TENNANT_ID=$(az account show --query tenantId -o tsv)
     echo "##vso[task.setvariable variable=tenantId;issecret=true]$TENNANT_ID"

- task: AzureCLI@2
  displayName: Get The ClientId Of The UMI That Have Access To Key Vault (save result to aksUmiClientId variable)
  inputs:
    azureSubscription: '$(azureserviceconnection)'
    scriptType: 'bash'
    scriptLocation: 'inlineScript'
    inlineScript: |
     CLIENT_ID=$(az aks show --name $(clusterName) --resource-group $(resourceGroupName) --query addonProfiles.azureKeyvaultSecretsProvider.identity.clientId -o tsv)
     echo "##vso[task.setvariable variable=aksUmiClientId;issecret=true]$CLIENT_ID"

- task: AzureCLI@2
  displayName: Get The ClientId Of The UMI That Have Access To The Catalog Api Db (save result to catalogApiUmiClientId variable)
  inputs:
    azureSubscription: '$(azureserviceconnection)'
    scriptType: 'bash'
    scriptLocation: 'inlineScript'
    inlineScript: |
     CLIENT_ID=$(az identity show --resource-group $(resourceGroupName) --name $(catalogApiUMIName) --query "clientId" -o tsv)
     echo "##vso[task.setvariable variable=catalogApiUmiClientId;issecret=true]$CLIENT_ID"

- task: AzureCLI@2
  displayName: Get The ClientId Of The UMI That Have Access To The Employee Management Db (save result to employeeManagementUmiClientId variable)
  inputs:
    azureSubscription: '$(azureserviceconnection)'
    scriptType: 'bash'
    scriptLocation: 'inlineScript'
    inlineScript: |
     CLIENT_ID=$(az identity show --resource-group $(resourceGroupName) --name $(employeeManagementUMIName) --query "clientId" -o tsv)
     echo "##vso[task.setvariable variable=employeeManagementUmiClientId;issecret=true]$CLIENT_ID"

- task: AzureCLI@2
  displayName: Get The ClientId Of The UMI That Have Access To The Client Authorization Server Db (save result to clientAuthserverUmiClientId variable)
  inputs:
    azureSubscription: '$(azureserviceconnection)'
    scriptType: 'bash'
    scriptLocation: 'inlineScript'
    inlineScript: |
     CLIENT_ID=$(az identity show --resource-group $(resourceGroupName) --name $(clientAuthServerUMIName) --query "clientId" -o tsv)
     echo "##vso[task.setvariable variable=clientAuthserverUmiClientId;issecret=true]$CLIENT_ID"

- task: AzureCLI@2
  displayName: Get The Client Portal Gateway DNS Name (save result to clientPortalDnsName variable)
  inputs:
    azureSubscription: '$(azureserviceconnection)'
    scriptType: 'bash'
    scriptLocation: 'inlineScript'
    inlineScript: |
     DNS_NAME=$(dnsLabel).$(az aks show --name $(clusterName) --resource-group $(resourceGroupName) --query location -otsv).cloudapp.azure.com
     echo "##vso[task.setvariable variable=clientPortalDnsName;issecret=false]$DNS_NAME"

- task: Kubernetes@1
  name: getLoadBalancerIP
  displayName: Get Load Balancer IP
  inputs:
    connectionType: 'Azure Resource Manager'
    azureSubscriptionEndpoint: '$(azureserviceconnection)'
    azureResourceGroup: '$(resourceGroupName)'
    kubernetesCluster: '$(clusterName)'
    namespace: 'default'
    command: 'get'
    arguments: 'services ingress-nginx-controller -n ingress-nginx -o jsonpath="{.status.loadBalancer.ingress[0].ip}'
    outputFormat: none

- powershell: |
    echo "##vso[task.setvariable variable=empoyeePortalDnsName;issecret=false]$(getLoadBalancerIP.KUBECTLOUTPUT).nip.io"
  displayName: Save result to empoyeePortalDnsName variable

- task: HelmDeploy@0
  displayName: Deploy Helm Package
  inputs:
    connectionType: 'Azure Resource Manager'
    azureSubscription: '$(azureserviceconnection)'
    azureResourceGroup: '$(resourceGroupName)'
    kubernetesCluster: '$(clusterName)'
    azureSubscriptionForACR: '$(azureserviceconnection)'
    azureResourceGroupForACR: '$(resourceGroupName)'
    azureContainerRegistry: '$(acrConnection)'
    namespace: 'eshop'
    command: 'upgrade'
    chartType: 'FilePath'
    chartPath: '$(Pipeline.Workspace)/eshop-on-microservices-ci-aks/Helm/eshop-$(resources.pipeline.eshop-on-microservices-ci-aks.runID).tgz'
    releaseName: 'eshop'
    overrideValues: 'useAks=true,imagesTag=kube-$(resources.pipeline.eshop-on-microservices-ci-aks.runID),dockerRegistry=$(acrName).azurecr.io,azure.tenantId=$(tenantId),azure.aksUmiClientId=$(aksUmiClientId),azure.akvName=$(akvName),azure.catalogApiUmiClientId=$(catalogApiUmiClientId),azure.employeeManagementUmiClientId=$(employeeManagementUmiClientId),azure.clientAuthserverUmiClientId=$(clientAuthserverUmiClientId),azure.catalogApiSqlServerName=$(catalogApiSqlServerName),azure.employeeManagementSqlServerName=$(employeeManagementSqlServerName),azure.clientAuthserverSqlServerName=$(clientAuthserverSqlServerName),eshop_ingress.clientPortalDnsName=$(clientPortalDnsName),eshop_ingress.empoyeePortalDnsName=$(empoyeePortalDnsName),employee_external_authserver.issuer=$(employeeExternalOAuthIssuer),employee_external_authserver.metadataAddress=$(employeeExternalOAuthMetadataEndpoint),employee_external_authserver.audience=$(employeeExternalOAuthAudience)'
    arguments: '--timeout 2m --debug --create-namespace'
  
