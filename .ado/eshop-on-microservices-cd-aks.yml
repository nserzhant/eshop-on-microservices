resources:
 repositories:
   - repository: self
     trigger: none
 pipelines:
  - pipeline: eshop-on-microservices-ci-aks
    source: eshop-on-microservices-ci-aks

variables:
  azureserviceconnection: 'azure-owner-role-spn' #'$(azureserviceconnection)'
  suffix:  ${{ split(variables['System.TeamProjectId'], '-')[0]}} # Pseudo - random string based on project Id
  resourceGroupName: 'eshop-on-microservices-rg'
  clusterName: 'aks-eshop-$(suffix)'
  acrConnection: 'acr-docker-connection'
  acrName: $(acr-name)
  dnsLabel: 'eshop-client-portal-$(suffix)'
  akvName: 'akv-eshop-$(suffix)'
  catalogApiSqlServerName: 'catalog-sqlserver-$(suffix)'
  employeeManagementSqlServerName: 'employee-sqlserver-$(suffix)'
  clientAuthserverSqlServerName: 'client-sqlserver-$(suffix)'
  catalogApiUMIName: 'catalog-api-identity'
  employeeManagementUMIName: 'employee-management-identity'
  clientAuthServerUMIName: 'client-authserver-identity'
pool:
  vmImage: windows-latest
steps:

- checkout: none
- download: eshop-on-microservices-ci-aks

- task: AzureCLI@2
  displayName: Get The Tenant Id (save result to tenantId variable)
  inputs:
    azureSubscription: '$(azureserviceconnection)'
    scriptType: 'bash'
    scriptLocation: 'inlineScript'
    inlineScript: |
     TENNANT_ID=$(az account show --query tenantId -o tsv)
     echo "##vso[task.setvariable variable=tenantId;issecret=false]$TENNANT_ID"

- task: AzureCLI@2
  displayName: Get The ClientId Of The UMI That Have Access To Key Vault (save result to aks_umi_client_id variable)
  inputs:
    azureSubscription: '$(azureserviceconnection)'
    scriptType: 'bash'
    scriptLocation: 'inlineScript'
    inlineScript: |
     CLIENT_ID=$(az aks show --name $(clusterName) --resource-group $(resourceGroupName) --query addonProfiles.azureKeyvaultSecretsProvider.identity.clientId -o tsv)
     echo "##vso[task.setvariable variable=aks_umi_client_id;issecret=false]$CLIENT_ID"

- task: AzureCLI@2
  displayName: Get The ClientId Of The UMI That Have Access To The Catalog Api Db (save result to catalog_api_umi_client_id variable)
  inputs:
    azureSubscription: '$(azureserviceconnection)'
    scriptType: 'bash'
    scriptLocation: 'inlineScript'
    inlineScript: |
     CLIENT_ID=$(az identity show --resource-group $(resourceGroupName) --name $(catalogApiUMIName) --query "clientId" -o tsv)
     echo "##vso[task.setvariable variable=catalog_api_umi_client_id;issecret=false]$CLIENT_ID"

- task: AzureCLI@2
  displayName: Get The ClientId Of The UMI That Have Access To The Employee Management Db (save result to employee_management_umi_client_id variable)
  inputs:
    azureSubscription: '$(azureserviceconnection)'
    scriptType: 'bash'
    scriptLocation: 'inlineScript'
    inlineScript: |
     CLIENT_ID=$(az identity show --resource-group $(resourceGroupName) --name $(employeeManagementUMIName) --query "clientId" -o tsv)
     echo "##vso[task.setvariable variable=employee_management_umi_client_id;issecret=false]$CLIENT_ID"

- task: AzureCLI@2
  displayName: Get The ClientId Of The UMI That Have Access To The Client Authorization Server Db (save result to client_authserver_umi_client_id variable)
  inputs:
    azureSubscription: '$(azureserviceconnection)'
    scriptType: 'bash'
    scriptLocation: 'inlineScript'
    inlineScript: |
     CLIENT_ID=$(az identity show --resource-group $(resourceGroupName) --name $(clientAuthServerUMIName) --query "clientId" -o tsv)
     echo "##vso[task.setvariable variable=client_authserver_umi_client_id;issecret=false]$CLIENT_ID"

- task: AzureCLI@2
  displayName: Get The Client Portal Gateway DNS Name (save result to client_portal_dns_name variable)
  inputs:
    azureSubscription: '$(azureserviceconnection)'
    scriptType: 'bash'
    scriptLocation: 'inlineScript'
    inlineScript: |
     DNS_NAME=$(az network public-ip list --query "[?dnsSettings.domainNameLabel=='$(dnsLabel)'].dnsSettings.fqdn" -otsv)
     echo "##vso[task.setvariable variable=client_portal_dns_name;issecret=false]$DNS_NAME"

- task: AzureCLI@2
  displayName: Get The Employee Portal Gateway DNS Name (save result to empoyee_portal_dns_name variable)
  inputs:
    azureSubscription: '$(azureserviceconnection)'
    scriptType: 'bash'
    scriptLocation: 'inlineScript'
    inlineScript: |
     DNS_NAME=$(az network public-ip list --query "[?dnsSettings.domainNameLabel=='$(dnsLabel)'].ipAddress" -otsv).nip.io
     echo "##vso[task.setvariable variable=empoyee_portal_dns_name;issecret=false]$DNS_NAME"

- task: HelmDeploy@0
  displayName: Deploy Helm Package
  inputs:
    connectionType: 'Azure Resource Manager'
    azureSubscription: '$(azureserviceconnection)'
    azureResourceGroup: '$(resourceGroupName)'
    kubernetesCluster: '$(clusterName)'
    azureSubscriptionForACR: '$(azureserviceconnection)'
    azureResourceGroupForACR: '$(resourceGroupName)'
    azureContainerRegistry: '$(acrConnection)'
    namespace: 'eshop'
    command: 'upgrade'
    chartType: 'FilePath'
    chartPath: '$(Pipeline.Workspace)/eshop-on-microservices-ci-aks/Helm/eshop-$(resources.pipeline.eshop-on-microservices-ci-aks.runID).tgz'
    releaseName: 'eshop'
    overrideValues: 'useAks=true,imagesTag=kube-$(resources.pipeline.eshop-on-microservices-ci-aks.runID),dockerRegistry=$(acrName).azurecr.io,azure.tenantId=$(tenantId),azure.aksUmiClientId=$(aks_umi_client_id),azure.akvName=$(akvName),azure.catalogApiUmiClientId=$(catalog_api_umi_client_id),azure.employeeManagementUmiClientId=$(employee_management_umi_client_id),azure.clientAuthserverUmiClientId=$(client_authserver_umi_client_id),azure.catalogApiSqlServerName=$(catalogApiSqlServerName),azure.employeeManagementSqlServerName=$(employeeManagementSqlServerName),azure.clientAuthserverSqlServerName=$(clientAuthserverSqlServerName),eshop_ingress.clientPortalDnsName=$(client_portal_dns_name),eshop_ingress.empoyeePortalDnsName=$(empoyee_portal_dns_name)'
    arguments: '--timeout 2m --debug --create-namespace'