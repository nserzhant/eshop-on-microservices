name: Eshop CI Docker

on:
  workflow_dispatch:
  
env:
  buildConfiguration: Release
  apiWorkingDirectory: ./eshop-api
  sqlPassword: sqlP@ssw0rd
  
jobs:
  test_api:
    runs-on: ubuntu-latest

    container:
      image: mcr.microsoft.com/dotnet/sdk:8.0.203
      env:
        ConnectionStrings__catalogDbConnectionString: Server=tcp:mssql;Integrated Security=false;Initial Catalog=eshop.catalog.testDb;User Id=sa;password=${{ env.sqlPassword }};TrustServerCertificate=true
        ConnectionStrings__employeeDbConnectionString: Server=tcp:mssql;Integrated Security=false;Initial Catalog=eshop.employee.testDb;User Id=sa;password=${{ env.sqlPassword }};TrustServerCertificate=true
        ConnectionStrings__orderingDbConnectionString: Server=tcp:mssql;Integrated Security=false;Initial Catalog=eshop.ordering.testDb;User Id=sa;password=${{ env.sqlPassword }};TrustServerCertificate=true
        ConnectionStrings__redisConnectionString: redis:6379

    services:
      mssql:
        image: mcr.microsoft.com/mssql/server:2022-latest
        env:
          MSSQL_SA_PASSWORD: ${{ env.sqlPassword }}
          ACCEPT_EULA: Y
        ports:
        - 1433
      redis:
        image: redis:7.0.15-alpine3.20
        ports:
        - 6379
          
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Setup .NET Core SDK
      uses: actions/setup-dotnet@v4.0.0
      with:
        dotnet-version: 8.0.x
          
    - name: Restore
      run: dotnet restore ${{ env.apiWorkingDirectory }}/eshop-api.sln
      
    - name: Build
      run: dotnet build ${{ env.apiWorkingDirectory }}/eshop-api.sln -c ${{ env.buildConfiguration }} --no-restore
      
    - name: Run Tests
      run: dotnet test ${{ env.apiWorkingDirectory }}/eshop-api.sln  --filter TestCategory!=MicroservicesIntegration --verbosity normal 
    
  build:
    needs: test_api

    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ vars.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}
        
    - name: Build And Push Docker Images
      env:
        TAG: run_id-${{github.run_id}}
        DOCKER_REGISTRY: ${{ vars.DOCKERHUB_USERNAME }}/
        ANGULAR_CONFIGURATION: production
        APPDATA: ''
        OAUTH_AUTH_EMPOYEE_ENDPOINT_PATH: '/authorize'
        OAUTH_EMPOYEE_APP_CLIENT_ID: 'employee-portal'
        OAUTH_EMPOYEE_SCOPE: 'openid roles api offline_access'
      run: |
        docker compose build    
        docker compose push
        
    - name: Upload Artifact - Bicep
      uses: actions/upload-artifact@v4.3.1
      with:
        name: Bicep
        path: .azure

    - name: Upload Artifact - Envoy configuration
      uses: actions/upload-artifact@v4.3.1
      with:
        name: Envoy
        path: ./.config/envoy
